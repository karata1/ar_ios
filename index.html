<!DOCTYPE html>
<html>
<head>
    <title>GPS WebAR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }

        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            z-index: 999999;
            font-size: 16px;
            width: 200px;
            border-radius: 10px;
        }

        #compass {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            z-index: 999999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 40px solid red;
            transform-origin: center;
        }

        #distance {
            position: fixed;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            z-index: 999999;
            font-size: 16px;
            border-radius: 10px;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
        <div>Загрузка, пожалуйста подождите...</div>
    </div>

    <div id="debug">Инициализация...</div>
    <div id="distance">Расстояние: ...</div>
    <div id="compass"><div id="arrow"></div></div>

    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true"
        embedded
    >
        <a-camera gps-camera="minDistance: 0; maxDistance: 100000; positionMinAccuracy: 100;" rotation-reader></a-camera>
        
        <a-entity 
            geometry="primitive: box"
            material="color: red"
            scale="50 50 50"
            position="0 0 0"
            rotation="0 0 0"
            gps-entity-place="latitude: 51.145929; longitude: 71.471594; static-tracking: true; fixedPosition: true"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 10000"
        ></a-entity>
    </a-scene>

    <script>
        window.onload = () => {
            const debug = document.querySelector('#debug');
            const distance = document.querySelector('#distance');
            const arrow = document.querySelector('#arrow');
            let currentBearing = 0;
            let deviceHeading = 0;
            
            function updateDebugInfo(info) {
                debug.innerHTML = Object.entries(info)
                    .map(([key, value]) => `<strong>${key}:</strong><br>${typeof value === 'object' ? 
                        Object.entries(value).map(([k, v]) => `${k}: ${v}`).join('<br>') : 
                        value}`)
                    .join('<br><br>');
            }

            // Запрашиваем разрешение на использование датчиков
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            function handleOrientation(e) {
                if (e.webkitCompassHeading) {
                    deviceHeading = Math.round(e.webkitCompassHeading * 100) / 100;
                } else if (e.alpha) {
                    deviceHeading = Math.round((360 - e.alpha) * 100) / 100;
                }
                updateArrow();
            }

            function calculateBearing(lat1, lon1, lat2, lon2) {
                lat1 = lat1 * Math.PI / 180;
                lat2 = lat2 * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;

                const y = Math.sin(dLon) * Math.cos(lat2);
                const x = Math.cos(lat1) * Math.sin(lat2) -
                        Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

                let bearing = Math.atan2(y, x) * 180 / Math.PI;
                bearing = Math.round((bearing + 360) % 360 * 100) / 100;
                return bearing;
            }

            function updateArrow() {
                const rotation = Math.round((currentBearing - deviceHeading) * 100) / 100;
                arrow.style.transform = `rotate(${rotation}deg)`;
                
                updateDebugInfo({
                    "Направление": {
                        "Компас": deviceHeading.toFixed(2) + "°",
                        "Цель": currentBearing.toFixed(2) + "°",
                        "Поворот": rotation.toFixed(2) + "°"
                    }
                });
            }

            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const currentCoords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };

                        const targetCoords = {
                            latitude: 51.145929,
                            longitude: 71.471594
                        };
                        
                        // Расчет расстояния
                        const R = 6371e3;
                        const φ1 = currentCoords.latitude * Math.PI/180;
                        const φ2 = targetCoords.latitude * Math.PI/180;
                        const Δφ = (targetCoords.latitude - currentCoords.latitude) * Math.PI/180;
                        const Δλ = (targetCoords.longitude - currentCoords.longitude) * Math.PI/180;

                        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                                Math.cos(φ1) * Math.cos(φ2) *
                                Math.sin(Δλ/2) * Math.sin(Δλ/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const d = (R * c).toFixed(0);

                        // Обновляем расстояние
                        distance.innerHTML = `Расстояние: ${d} м`;

                        // Обновляем направление
                        currentBearing = calculateBearing(
                            currentCoords.latitude,
                            currentCoords.longitude,
                            targetCoords.latitude,
                            targetCoords.longitude
                        );
                        
                        updateArrow();
                        
                        updateDebugInfo({
                            "Координаты": {
                                "Широта": currentCoords.latitude.toFixed(6),
                                "Долгота": currentCoords.longitude.toFixed(6)
                            }
                        });
                    },
                    (err) => {
                        updateDebugInfo({
                            "Ошибка": err.message
                        });
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 27000
                    }
                );
            }

            const scene = document.querySelector('a-scene');
            
            if (scene.hasLoaded) {
                run();
            } else {
                scene.addEventListener('loaded', run);
            }

            function run() {
                setTimeout(() => {
                    const loader = document.querySelector('.arjs-loader');
                    if (loader) {
                        loader.remove();
                    }
                }, 1000);
            }
        };
    </script>
</body>
</html> 